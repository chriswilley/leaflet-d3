/*! @asymmetrik/leaflet-d3 - 2.0.3 - Copyright (c) 2007-2017 Asymmetrik Ltd, a Maryland Corporation */
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("d3"),require("d3-hexbin"),require("leaflet")):"function"==typeof define&&define.amd?define(["exports","d3","d3-hexbin","leaflet"],i):i(t.leafletD3=t.leafletD3||{},t.d3,t.d3.hexbin)}(this,function(t,i,n){"use strict";var a=null!=i.hexbin?i.hexbin:null!=n?n.hexbin:null;L.HexbinLayer=(L.Layer?L.Layer:L.Class).extend({includes:[L.Evented],options:{radius:12,radiusUnits:"pixels",opacity:.6,hasStroke:!0,strokeColor:"#000000",strokeOpacity:.6,strokeWidth:.5,duration:200,colorScaleExtent:[1,void 0],radiusScaleExtent:[1,void 0],colorRange:["#f7fbff","#08306b"],radiusRange:[4,12],pointerEvents:"all"},initialize:function(t){L.setOptions(this,t),this._fn={lng:function(t){return t[0]},lat:function(t){return t[1]},colorValue:function(t){return t.length},radiusValue:function(t){return Number.MAX_VALUE},fill:function(t){var i=this._fn.colorValue(t);return null!=i?this._scale.color(i):"none"}},this._scale={color:i.scaleLinear(),radius:i.scaleLinear()},this._dispatch=i.dispatch("mouseover","mouseout","click"),this._data=[],this._bins=[],this._width=0,this._widthMeters=0,this._height=0,this._heightMeters=0,this.marginTop=0,this.marginLeft=0,this._marginTopMap=0,this._marginLeftMap=0,this._scale.color.range(this.options.colorRange).clamp(!0),this._scale.radius.range(this.options.radiusRange).clamp(!0),this._convertedRadius=0,this.options.hasStroke?(this._strokeColor=this.options.strokeColor,this._strokeOpacity=this.options.strokeOpacity,this._strokeWidth=this.options.strokeWidth+"px"):(this._strokeColor=null,this._strokeOpacity=null,this.strokeWidth=null),this._calculatedColorRangeExtent={min:0,max:0}},onAdd:function(t){this._map=t,this._convertedRadius=this.options.radius,"meters"===this.options.radiusUnits&&(this._convertedRadius=this.options.radius/this._calcMPPY(t),t.on({zoomend:function(){this._convertedRadius=this.options.radius/this._calcMPPY(t),this._setupGrid(this._convertedRadius)}},this)),this._setupGrid(this._convertedRadius),this._initContainer(),t.on({moveend:this.redraw},this),this.makeBins(),this.redraw()},onRemove:function(t){this._destroyContainer(),t.off({moveend:this.redraw},this),this._container=null,this._map=null},_initContainer:function(){if(null==this._container){var t=this._map.getPanes().overlayPane;this._container=i.select(t).append("svg").attr("class","leaflet-layer leaflet-zoom-hide")}},_destroyContainer:function(){null!=this._container&&this._container.remove()},makeBins:function(){for(var t=this,i=[],n=0;n<t._data.length;n++){var a=t._data[n],e=t._fn.lng(a),o=t._fn.lat(a),s=t._project([e,o]);i.push({o:a,point:s})}for(var r=t._hexLayout(i),h=0;h<r.length;h++){var l=r[h],u=this._fn.colorValue(l),c=this._unproject([l.x,l.y]);l.lat=c[0],l.lng=c[1],l.val=u}t._bins=r;var _=t._getExtent(r,t._fn.colorValue,t.options.colorScaleExtent),d=t._getExtent(r,t._fn.radiusValue,t.options.radiusScaleExtent),p=t._linearlySpace(_[0],_[1],t._scale.color.range().length);t._scale.color.domain(p),t._scale.radius.domain(d),t._calculatedColorRangeExtent.min=_[0],t._calculatedColorRangeExtent.max=_[1];var f=512,g=this._getBounds(i),m=t._calcMPPX(t._map),y=t._calcMPPY(t._map),x=g.max[0]-g.min[0];t._widthMeters=m*x,t._width=x+2*f;var v=g.max[1]-g.min[1];t._heightMeters=y*v,t._height=v+2*f;var L=g.min[1];t._marginTop=L-f;var k=g.min[0];t._marginLeft=k-f;var C=this._unproject([k,L]);t._marginLeftMap=C[0],t._marginTopMap=C[1]},updateBins:function(){for(var t=this,i=t._bins,n=0;n<i.length;n++){var a=i[n],e=t._project([a.lng,a.lat]);a.x=e[0],a.y=e[1]}},updateBounds:function(){var t=this,i=512,n=t._calcMPPX(t._map),a=t._calcMPPY(t._map);t._width=t._widthMeters/n+2*i,t._height=t._heightMeters/a+2*i;var e=t._project([t._marginTopMap,t._marginLeftMap]);t._marginTop=e[1]-i,t._marginLeft=e[0]-i},redraw:function(){var t=this;if(t._map){this.updateBounds(),this._container.attr("width",t._width).attr("height",t._height).style("margin-left",t._marginLeft+"px").style("margin-top",t._marginTop+"px");var i=this._container.selectAll("g.hexbin").data([this._map.getZoom()],function(t){return t}),n=i.enter().append("g").attr("class",function(t){return"hexbin zoom-"+t}),a=n.merge(i);a.attr("transform","translate("+-t._marginLeft+","+-t._marginTop+")"),i.exit().remove(),"meters"===t.options.radiusUnits?this.updateBins():this.makeBins(),this._createHexagons(a)}},_createHexagons:function(t){var i=this,n=i._bins,a=t.selectAll("path.hexbin-hexagon").data(n,function(t){return t.x+":"+t.y});a.transition().duration(i.options.duration).attr("fill",i._fn.fill.bind(i)).attr("fill-opacity",i.options.opacity).attr("stroke",i._strokeColor).attr("stroke-opacity",i._strokeOpacity).attr("stroke-width",i._strokeWidth).attr("d",function(t){return"pixels"===i.options.radiusUnits?i._hexLayout.hexagon(i._scale.radius(i._fn.radiusValue.call(i,t))):i._hexLayout.hexagon(i._convertedRadius)}),a.enter().append("path").attr("class","hexbin-hexagon").style("pointer-events",i.options.pointerEvents).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).attr("d",function(t){return i._hexLayout.hexagon(0)}).attr("fill",i._fn.fill.bind(i)).attr("fill-opacity",i.options.opacity).attr("stroke",i._strokeColor).attr("stroke-opacity",i._strokeOpacity).attr("stroke-width",i._strokeWidth).on("mouseover",function(t,n){i._dispatch.call("mouseover",this,t,n)}).on("mouseout",function(t,n){i._dispatch.call("mouseout",this,t,n)}).on("click",function(t,n){i._dispatch.call("click",this,t,n)}).transition().duration(i.options.duration).attr("fill-opacity",i.options.opacity).attr("stroke",i._strokeColor).attr("stroke-opacity",i._strokeOpacity).attr("stroke-width",i._strokeWidth).attr("d",function(t){return"pixels"===i.options.radiusUnits?i._hexLayout.hexagon(i._scale.radius(i._fn.radiusValue.call(i,t))):i._hexLayout.hexagon(i._convertedRadius)}),a.exit().transition().duration(i.options.duration).attr("fill-opacity",i.options.opacity).attr("stroke",i._strokeColor).attr("stroke-opacity",i._strokeOpacity).attr("stroke-width",i._strokeWidth).attr("d",function(t){return i._hexLayout.hexagon(0)}).remove()},_getExtent:function(t,n,a){var e=i.extent(t,n.bind(this));return null==e[0]&&(e[0]=0),null==e[1]&&(e[1]=0),null!=a[0]&&(e[0]=a[0]),null!=a[1]&&(e[1]=a[1]),e},_unproject:function(t){var i=this._map.layerPointToLatLng(L.point(t[0],t[1]));return[i.lat,i.lng]},_project:function(t){var i=this._map.project([t[1],t[0]]),n=i._subtract(this._map.getPixelOrigin());return[n.x,n.y]},_getBounds:function(t){if(null==t||t.length<1)return{min:[0,0],max:[0,0]};var i=[[999,999],[-999,-999]];return t.forEach(function(t){var n=t.point[0],a=t.point[1];i[0][0]=Math.min(i[0][0],n),i[0][1]=Math.min(i[0][1],a),i[1][0]=Math.max(i[1][0],n),i[1][1]=Math.max(i[1][1],a)}),{min:i[0],max:i[1]}},_linearlySpace:function(t,i,n){for(var a=new Array(n),e=(i-t)/Math.max(n-1,1),o=0;o<n;++o)a[o]=t+o*e;return a},_setupGrid:function(t){this._hexLayout=a().radius(t).x(function(t){return t.point[0]}).y(function(t){return t.point[1]})},_calcMPPX:function(t){var i=t.getCenter(),n=t.latLngToContainerPoint(i),a=[n.x+1,n.y],e=t.containerPointToLatLng(n),o=t.containerPointToLatLng(a);return e.distanceTo(o)},_calcMPPY:function(t){var i=t.getZoom()+8,n=t.getCenter(),a=t.latLngToContainerPoint(n),e=[a.x,a.y+i],o=t.containerPointToLatLng(a),s=t.containerPointToLatLng(e);return o.distanceTo(s)/i},radius:function(t){return arguments.length?(this.options.radius=t,this._hexLayout.radius(t),this):this.options.radius},opacity:function(t){return arguments.length?(this.options.opacity=t,this):this.options.opacity},duration:function(t){return arguments.length?(this.options.duration=t,this):this.options.duration},colorScaleExtent:function(t){return arguments.length?(this.options.colorScaleExtent=t,this):this.options.colorScaleExtent},radiusScaleExtent:function(t){return arguments.length?(this.options.radiusScaleExtent=t,this):this.options.radiusScaleExtent},colorRange:function(t){return arguments.length?(this.options.colorRange=t,this._scale.color.range(t),this):this.options.colorRange},radiusRange:function(t){return arguments.length?(this.options.radiusRange=t,this._scale.radius.range(t),this):this.options.radiusRange},colorScale:function(t){return arguments.length?(this._scale.color=t,this):this._scale.color},radiusScale:function(t){return arguments.length?(this._scale.radius=t,this):this._scale.radius},lng:function(t){return arguments.length?(this._fn.lng=t,this):this._fn.lng},lat:function(t){return arguments.length?(this._fn.lat=t,this):this._fn.lat},colorValue:function(t){return arguments.length?(this._fn.colorValue=t,this):this._fn.colorValue},radiusValue:function(t){return arguments.length?(this._fn.radiusValue=t,this):this._fn.radiusValue},fill:function(t){return arguments.length?(this._fn.fill=t,this):this._fn.fill},data:function(t){return arguments.length?(this._data=null!=t?t:[],this.redraw(),this):this._data},dispatch:function(){return this._dispatch},getLatLngs:function(){var t=this;return this._data.map(function(i){return L.latLng(t.options.lat(i),t.options.lng(i))})},toGeoJSON:function(){return L.GeoJSON.getFeature(this,{type:"LineString",coordinates:L.GeoJSON.latLngsToCoords(this.getLatLngs(),0)})}}),L.hexbinLayer=function(t){return new L.HexbinLayer(t)},L.PingLayer=(L.Layer?L.Layer:L.Class).extend({includes:[L.Evented],options:{duration:800,fps:32,opacityRange:[1,0],radiusRange:[3,15]},initialize:function(t){L.setOptions(this,t),this._fn={lng:function(t){return t[0]},lat:function(t){return t[1]},radiusScaleFactor:function(t){return 1}},this._scale={radius:i.scalePow().exponent(.35),opacity:i.scaleLinear()},this._lastUpdate=Date.now(),this._fps=0,this._mapBounds=void 0,this._scale.radius.domain([0,this.options.duration]).range(this.options.radiusRange).clamp(!0),this._scale.opacity.domain([0,this.options.duration]).range(this.options.opacityRange).clamp(!0)},onAdd:function(t){this._map=t,this._running=!1,this._initContainer(),this._updateContainer(),t.on({move:this._move},this)},onRemove:function(t){this._destroyContainer(),t.off({move:this._move},this),this._container=null,this._map=null,this._data=null},_initContainer:function(){if(null==this._container){var t=this._map.getPanes().overlayPane;this._container=i.select(t).append("svg").attr("class","leaflet-layer leaflet-zoom-hide")}},_updateContainer:function(){var t=this._getMapBounds();this._mapBounds=t,this._container.attr("width",t.width).attr("height",t.height).style("margin-left",t.left+"px").style("margin-top",t.top+"px"),this._update(!0)},_destroyContainer:function(){null!=this._container&&this._container.remove()},_getMapBounds:function(){var t=this._map.getBounds(),i=this._map.latLngToLayerPoint(t.getNorthEast()),n=this._map.latLngToLayerPoint(t.getSouthWest()),a={width:i.x-n.x,height:n.y-i.y,left:n.x,top:i.y};return a},_getCircleCoords:function(t){var i=this._map.latLngToLayerPoint(t);return{x:i.x-this._mapBounds.left,y:i.y-this._mapBounds.top}},_move:function(){this._updateContainer()},_add:function(t,i){null==this._data&&(this._data=[]);var n=[this._fn.lat(t),this._fn.lng(t)],a=this._getCircleCoords(n),e={data:t,geo:n,ts:Date.now(),nts:0};e.c=this._container.append("circle").attr("class",null!=i?"ping "+i:"ping").attr("cx",a.x).attr("cy",a.y).attr("r",this._fn.radiusScaleFactor.call(this,t)*this._scale.radius.range()[0]),this._data.push(e)},_update:function(t){var i=Date.now();null==this._data&&(this._data=[]);for(var n=-1,a=0;a<this._data.length;a++){var e=this._data[a],o=i-e.ts;if(this.options.duration<o)e.c.remove(),n=a;else if(t||e.nts<i){var s=this._getCircleCoords(e.geo);e.c.attr("cx",s.x).attr("cy",s.y).attr("r",this._fn.radiusScaleFactor.call(this,e.data)*this._scale.radius(o)).attr("fill-opacity",this._scale.opacity(o)).attr("stroke-opacity",this._scale.opacity(o)),e.nts=Math.round(i+1e3/this.options.fps)}}return n>-1&&this._data.splice(0,n+1),this._running=this._data.length>0,this._running&&(this._fps=1e3/(i-this._lastUpdate),this._lastUpdate=i),!this._running},_expire:function(){for(var t=-1,i=Date.now(),n=0;n<this._data.length;n++){var a=this._data[n],e=i-a.ts;if(!(this.options.duration<e))break;a.c.remove(),t=n}t>-1&&this._data.splice(0,t+1)},duration:function(t){return arguments.length?(this.options.duration=t,this):this.options.duration},fps:function(t){return arguments.length?(this.options.fps=t,this):this.options.fps},lng:function(t){return arguments.length?(this._fn.lng=t,this):this._fn.lng},lat:function(t){return arguments.length?(this._fn.lat=t,this):this._fn.lat},radiusRange:function(t){return arguments.length?(this.options.radiusRange=t,this._scale.radius().range(t),this):this.options.radiusRange},opacityRange:function(t){return arguments.length?(this.options.opacityRange=t,this._scale.opacity().range(t),this):this.options.opacityRange},radiusScale:function(t){return arguments.length?(this._scale.radius=t,this):this._scale.radius},opacityScale:function(t){return arguments.length?(this._scale.opacity=t,this):this._scale.opacity},radiusScaleFactor:function(t){return arguments.length?(this._fn.radiusScaleFactor=t,this):this._fn.radiusScaleFactor},ping:function(t,n){if(this._add(t,n),this._expire(),!this._running&&this._data.length>0){this._running=!0,this._lastUpdate=Date.now();var a=this;i.timer(function(){a._update.call(a,!1)})}return this},getActualFps:function(){return this._fps},data:function(){return this._data}}),L.pingLayer=function(t){return new L.PingLayer(t)},Object.defineProperty(t,"__esModule",{value:!0})});